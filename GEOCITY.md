# GeoCity - åŸºäºçœå¸‚åœ°åŒºçš„è®¿é—®æ§åˆ¶

GeoCity æ˜¯ä¸€ä¸ªåŸºäº ip2region åº“çš„ Caddy æ¨¡å—ï¼Œæä¾›ç²¾ç»†çš„åœ°ç†ä½ç½®è®¿é—®æ§åˆ¶åŠŸèƒ½ã€‚æ”¯æŒçœä»½å’ŒåŸå¸‚çº§åˆ«çš„ç™½åå•/é»‘åå•æ§åˆ¶ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸŒ åŸºäº ip2region æ•°æ®åº“çš„ç²¾ç¡®åœ°ç†ä½ç½®è¯†åˆ«
- ğŸ™ï¸ æ”¯æŒçœä»½å’ŒåŸå¸‚çº§åˆ«çš„è®¿é—®æ§åˆ¶
- âœ… æ”¯æŒç™½åå•ï¼ˆallowï¼‰å’Œé»‘åå•ï¼ˆdenyï¼‰ä¸¤ç§æ¨¡å¼
- ğŸ”„ è‡ªåŠ¨æ›´æ–° ip2region æ•°æ®åº“
- ğŸš€ é«˜æ€§èƒ½ï¼Œä½å†…å­˜å ç”¨
- ğŸ›¡ï¸ æ”¯æŒå¤šç§ IP è·å–æ–¹å¼ï¼ˆRemoteAddr, X-Forwarded-For, X-Real-IPï¼‰

## é…ç½®å‚æ•°

### åŸºæœ¬é…ç½®

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `mode` | string | `allow` | åŒ¹é…æ¨¡å¼ï¼š`allow`ï¼ˆç™½åå•ï¼‰æˆ– `deny`ï¼ˆé»‘åå•ï¼‰ |
| `provinces` | []string | - | çœä»½åˆ—è¡¨ï¼ˆæ ¹æ®modeå†³å®šæ˜¯å…è®¸è¿˜æ˜¯æ‹’ç»ï¼‰ |
| `cities` | []string | - | åŸå¸‚åˆ—è¡¨ï¼ˆæ ¹æ®modeå†³å®šæ˜¯å…è®¸è¿˜æ˜¯æ‹’ç»ï¼‰ |

### é«˜çº§é…ç½®

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `local_file` | string | `{caddy_data_dir}/geocity/ip2region.xdb` | æœ¬åœ°æ•°æ®åº“æ–‡ä»¶è·¯å¾„ |
| `remote_file` | string | `https://github.com/lionsoul2014/ip2region/raw/master/data/ip2region.xdb` | è¿œç¨‹æ•°æ®åº“æ–‡ä»¶åœ°å€ |
| `interval` | duration | `24h` | æ•°æ®åº“æ›´æ–°é—´éš” |
| `timeout` | duration | `30s` | HTTP è¯·æ±‚è¶…æ—¶æ—¶é—´ |

## ä½¿ç”¨ç¤ºä¾‹

### 1. åŸºæœ¬ç™½åå•æ§åˆ¶

åªå…è®¸åŒ—äº¬å’Œä¸Šæµ·åœ°åŒºè®¿é—®ï¼š

```caddyfile
example.com {
    @beijing_shanghai {
        geocity {
            mode allow
            cities "åŒ—äº¬" "ä¸Šæµ·"
        }
    }
    
    handle @beijing_shanghai {
        file_server
    }
    
    handle {
        respond "ä»…é™åŒ—äº¬ã€ä¸Šæµ·åœ°åŒºè®¿é—®" 403
    }
}
```

### 2. çœä»½çº§åˆ«æ§åˆ¶

å…è®¸å¹¿ä¸œã€æµ™æ±Ÿã€æ±Ÿè‹ä¸‰çœè®¿é—®ï¼š

```caddyfile
example.com {
    @allowed_provinces {
        geocity {
            mode allow
            provinces "å¹¿ä¸œ" "æµ™æ±Ÿ" "æ±Ÿè‹"
        }
    }
    
    handle @allowed_provinces {
        reverse_proxy backend:8080
    }
    
    handle {
        respond "åœ°åŒºé™åˆ¶" 403
    }
}
```

### 3. é»‘åå•æ¨¡å¼

æ‹’ç»ç‰¹å®šåœ°åŒºè®¿é—®ï¼š

```caddyfile
example.com {
    @blocked {
        geocity {
            mode deny
            provinces "æ²³åŒ—"
            cities "çŸ³å®¶åº„"
        }
    }
    
    handle @blocked {
        respond "è¯¥åœ°åŒºæš‚ä¸æä¾›æœåŠ¡" 403
    }
    
    handle {
        file_server
    }
}
```

### 4. æ··åˆæ§åˆ¶

åŒæ—¶æŒ‡å®šçœä»½å’ŒåŸå¸‚ï¼š

```caddyfile
example.com {
    @geo_control {
        geocity {
            mode allow
            provinces "å¹¿ä¸œ" "æµ™æ±Ÿ"
            cities "åŒ—äº¬" "ä¸Šæµ·" "å¤©æ´¥" "é‡åº†"
        }
    }
    
    handle @geo_control {
        reverse_proxy app:3000
    }
    
    handle {
        respond "è®¿é—®å—é™" 403
    }
}
```

### 5. ä¸å…¶ä»–åŒ¹é…å™¨ç»„åˆ

ç»“åˆè·¯å¾„åŒ¹é…å™¨ä½¿ç”¨ï¼š

```caddyfile
api.example.com {
    @api_access {
        path /api/*
        geocity {
            mode allow
            provinces "åŒ—äº¬" "ä¸Šæµ·" "å¹¿ä¸œ"
        }
    }
    
    @public_access {
        path /public/*
    }
    
    handle @api_access {
        reverse_proxy api-server:8080
    }
    
    handle @public_access {
        file_server
    }
    
    handle {
        respond "API ä»…é™æŒ‡å®šåœ°åŒºè®¿é—®" 403
    }
}
```

## å·¥ä½œåŸç†

1. **IP è·å–**ï¼šæ¨¡å—ä¼šæŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§è·å–å®¢æˆ·ç«¯ IPï¼š
   - `RemoteAddr`ï¼ˆç›´æ¥è¿æ¥ï¼‰
   - `X-Forwarded-For` å¤´éƒ¨
   - `X-Real-IP` å¤´éƒ¨

2. **åœ°ç†ä½ç½®æŸ¥è¯¢**ï¼šä½¿ç”¨ ip2region æ•°æ®åº“æŸ¥è¯¢ IP å¯¹åº”çš„åœ°ç†ä½ç½®ä¿¡æ¯

3. **è§„åˆ™åŒ¹é…**ï¼š
   - **ç™½åå•æ¨¡å¼**ï¼š
     - ä¸­å›½IPï¼šåªæœ‰åœ¨å…è®¸åˆ—è¡¨ä¸­çš„çœä»½/åŸå¸‚æ‰èƒ½è®¿é—®
     - éä¸­å›½IPï¼šé»˜è®¤ä¸å…è®¸è®¿é—®
   - **é»‘åå•æ¨¡å¼**ï¼š
     - ä¸­å›½IPï¼šæ‹’ç»åˆ—è¡¨ä¸­çš„çœä»½/åŸå¸‚æ— æ³•è®¿é—®
     - éä¸­å›½IPï¼šé»˜è®¤å…è®¸è®¿é—®

4. **æ•°æ®åº“æ›´æ–°**ï¼šå®šæœŸæ£€æŸ¥å¹¶æ›´æ–° ip2region æ•°æ®åº“æ–‡ä»¶

## æ³¨æ„äº‹é¡¹

1. **ç§æœ‰ IP**ï¼šç§æœ‰ IP åœ°å€ï¼ˆå¦‚ 192.168.x.x, 10.x.x.xï¼‰ä¼šè¢«è‡ªåŠ¨è·³è¿‡
2. **æ•°æ®åº“æ–‡ä»¶**ï¼šé¦–æ¬¡è¿è¡Œæ—¶ä¼šè‡ªåŠ¨ä¸‹è½½ ip2region æ•°æ®åº“æ–‡ä»¶
3. **åŒ¹é…é€»è¾‘**ï¼šçœä»½å’ŒåŸå¸‚åç§°æ”¯æŒéƒ¨åˆ†åŒ¹é…ï¼ˆåŒ…å«å…³ç³»ï¼‰
4. **æ€§èƒ½è€ƒè™‘**ï¼šip2region æŸ¥è¯¢æ€§èƒ½å¾ˆé«˜ï¼Œé€‚åˆé«˜å¹¶å‘åœºæ™¯
5. **ä¸­å›½ IP**ï¼šç›®å‰åªå¤„ç†ä¸­å›½å¢ƒå†…çš„ IP åœ°å€

## æ„å»ºå’Œå®‰è£…

1. æ·»åŠ ä¾èµ–ï¼š
```bash
go get github.com/lionsoul2014/ip2region/binding/golang
```

2. æ„å»º Caddyï¼š
```bash
xcaddy build --with github.com/ysicing/caddy2-geocn
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ•°æ®åº“ä¸‹è½½å¤±è´¥**
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - ç¡®è®¤ `remote_file` åœ°å€å¯è®¿é—®
   - æ£€æŸ¥ç£ç›˜ç©ºé—´

2. **åœ°ç†ä½ç½®è¯†åˆ«ä¸å‡†ç¡®**
   - ip2region æ•°æ®åº“å¯èƒ½éœ€è¦æ›´æ–°
   - æŸäº› IP æ®µå¯èƒ½æ²¡æœ‰å‡†ç¡®çš„åœ°ç†ä½ç½®ä¿¡æ¯

3. **åŒ¹é…ä¸ç”Ÿæ•ˆ**
   - æ£€æŸ¥çœä»½/åŸå¸‚åç§°æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤å®¢æˆ·ç«¯ IP ä¸æ˜¯ç§æœ‰åœ°å€
   - æŸ¥çœ‹ Caddy æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯

### è°ƒè¯•æ¨¡å¼

å¯ç”¨è°ƒè¯•æ—¥å¿—ï¼š

```caddyfile
{
    log {
        level DEBUG
    }
}

example.com {
    @geo {
        geocity {
            mode allow
            cities "åŒ—äº¬"
        }
    }
    
    handle @geo {
        respond "OK"
    }
    
    handle {
        respond "Blocked" 403
    }
}
```

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ä¸åŸé¡¹ç›®ç›¸åŒçš„è®¸å¯è¯ã€‚
